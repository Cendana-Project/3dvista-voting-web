# Deployment Guide - GitHub Actions CI/CD

## Overview
Project ini menggunakan GitHub Actions untuk automatic deployment ke VPS menggunakan SSH.

## Setup GitHub Secrets

### Required Secrets

Tambahkan secrets berikut di repository GitHub Settings → Secrets and variables → Actions:

#### 1. VPS_HOST
```
your-vps-ip-or-domain.com
```
**Contoh:** `192.168.1.100` atau `deploy.example.com`

#### 2. VPS_USER
```
username-untuk-ssh
```
**Contoh:** `bitnami` atau `ubuntu` atau `root`

#### 3. VPS_SSH_KEY
```
-----BEGIN OPENSSH PRIVATE KEY-----
...
-----END OPENSSH PRIVATE KEY-----
```

**Cara Generate SSH Key:**

```bash
# Generate SSH key pair
ssh-keygen -t ed25519 -C "github-actions-deploy" -f ~/.ssh/github_actions_deploy

# Copy public key to VPS
ssh-copy-id -i ~/.ssh/github_actions_deploy.pub username@your-vps-ip

# Show private key to add as secret
cat ~/.ssh/github_actions_deploy
```

#### 4. IP_HASH_SALT
```
your-super-long-random-string-for-ip-hashing
```
**Contoh:** `change-me-to-long-random-string-at-least-32-characters`

Generate random string:
```bash
openssl rand -hex 32
```

#### 5. APP_BASE_URL
```
https://your-domain.com
```
**Contoh:** `https://vote.example.com` atau `http://192.168.1.100:8080`

#### 6. ADMIN_CODE
```
your-secure-admin-code-here
```
**Contoh:** `admin-secret-2024-change-this`

---

## VPS Requirements

### System Requirements
- **OS:** Ubuntu 20.04+ / Debian 11+ / Alpine Linux
- **Docker:** 20.10+
- **Docker Compose:** 2.0+
- **RAM:** Minimum 2GB (recommended 4GB)
- **Disk:** Minimum 20GB

### Install Docker on VPS

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Install Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Verify installation
docker --version
docker-compose --version
```

### Setup SSH Access

```bash
# On your local machine, generate SSH key
ssh-keygen -t ed25519 -C "deploy-key"

# Copy public key to VPS
ssh-copy-id -i ~/.ssh/id_ed25519.pub username@your-vps-ip

# Test SSH connection
ssh username@your-vps-ip
```

---

## Deployment Flow

### Automatic Deployment

1. **Push to main branch** → Triggers GitHub Actions
2. **SSH to VPS** → Connect using secrets
3. **Clone/Pull latest code** → From GitHub
4. **Setup environment** → Create `.env` file
5. **Stop old containers** → `docker-compose down`
6. **Build & start new containers** → `docker-compose up -d --build`
7. **Verify deployment** → Check container status
8. **Show logs** → Application logs

### Manual Deployment

Jika perlu deploy manual:

```bash
# SSH to VPS
ssh username@your-vps-ip

# Navigate to project
cd /home/bitnami/vote-3dvista

# Pull latest changes
git pull origin main

# Deploy
sudo docker-compose down
sudo docker-compose up -d --build

# Check status
sudo docker-compose ps

# View logs
sudo docker-compose logs -f app
```

---

## Workflow Details

### `.github/workflows/deploy.yml`

**Trigger:**
- Push ke `main` branch

**Steps:**
1. Clone/pull repository ke VPS
2. Create `.env` file dengan secrets
3. Stop old containers
4. Build & start new containers
5. Verify deployment
6. Show logs

### Directory Structure on VPS

```
/home/bitnami/
└── vote-3dvista/
    ├── docker-compose.yml
    ├── Dockerfile
    ├── .env (generated by workflow)
    ├── migrations/
    ├── web/
    └── ...
```

### Container Structure

```
vote-3dvista/
├── voteweb-db (PostgreSQL)
│   ├── Volume: postgres_data
│   └── Port: 5435:5432
└── voteweb-app (Go Application)
    ├── Depends on: voteweb-db
    └── Port: 8080:8080
```

---

## Environment Variables

### Application (.env)

```env
# Database
DATABASE_URL=postgres://postgres:postgres@db:5432/voteweb?sslmode=disable

# Security
IP_HASH_SALT=your-super-long-random-string
ADMIN_CODE=your-secure-admin-code

# Server
PORT=8080
GIN_MODE=release
APP_BASE_URL=https://your-domain.com

# Proxy
TRUST_PROXY=true
ALLOWED_PROXY_CIDRS=10.0.0.0/8,172.16.0.0/12,192.168.0.0/16

# Seed (set to false in production)
SEED=false
```

### GitHub Secrets Mapping

| GitHub Secret | Environment Variable | Description |
|--------------|---------------------|-------------|
| `VPS_HOST` | - | VPS IP or domain |
| `VPS_USER` | - | SSH username |
| `VPS_SSH_KEY` | - | SSH private key |
| `IP_HASH_SALT` | `IP_HASH_SALT` | IP hashing salt |
| `APP_BASE_URL` | `APP_BASE_URL` | Application base URL |
| `ADMIN_CODE` | `ADMIN_CODE` | Admin authentication code |

---

## Troubleshooting

### Issue: SSH Connection Failed

```bash
# Test SSH connection manually
ssh -i ~/.ssh/github_actions_deploy username@your-vps-ip

# Check SSH key format
# Make sure the key starts with "-----BEGIN OPENSSH PRIVATE KEY-----"
```

### Issue: Containers Not Starting

```bash
# Check logs
sudo docker-compose logs app
sudo docker-compose logs db

# Check container status
sudo docker-compose ps

# Restart containers
sudo docker-compose restart
```

### Issue: Database Connection Error

```bash
# Check database is healthy
sudo docker-compose exec db pg_isready -U postgres

# View database logs
sudo docker-compose logs db

# Check database volume
sudo docker volume ls | grep voteweb
```

### Issue: Application Not Responding

```bash
# Check app container is running
sudo docker-compose ps app

# Check port is exposed
sudo netstat -tulpn | grep 8080

# Check application logs
sudo docker-compose logs --tail=50 app
```

### Issue: Deployment Fails with "Permission Denied"

```bash
# Add user to docker group
sudo usermod -aG docker $USER
# Log out and log back in

# Or run with sudo
sudo docker-compose up -d
```

---

## Maintenance

### View Application Logs

```bash
# Real-time logs
sudo docker-compose logs -f app

# Last 100 lines
sudo docker-compose logs --tail=100 app

# Database logs
sudo docker-compose logs db
```

### Backup Database

```bash
# Create backup
sudo docker-compose exec db pg_dump -U postgres voteweb > backup.sql

# Or backup volume directly
sudo docker run --rm -v voteweb_postgres_data:/data -v $(pwd):/backup alpine tar czf /backup/postgres_backup.tar.gz /data
```

### Update Application

```bash
# Pull latest changes
git pull origin main

# Rebuild and restart
sudo docker-compose up -d --build

# Or use workflow
git push origin main  # Automatic deployment
```

### Rollback

```bash
# Stop current containers
sudo docker-compose down

# Checkout previous version
git checkout <previous-commit-hash>

# Restart with previous version
sudo docker-compose up -d --build

# Or restore from backup
sudo docker-compose exec db psql -U postgres voteweb < backup.sql
```

---

## Security Best Practices

### 1. SSH Key Security
- ✅ Store SSH private key as GitHub Secret
- ✅ Never commit SSH keys to repository
- ✅ Use strong passphrase for SSH key
- ✅ Rotate keys periodically

### 2. Environment Variables
- ✅ Store sensitive data in GitHub Secrets
- ✅ Never hardcode passwords or keys
- ✅ Use strong random strings for `IP_HASH_SALT`
- ✅ Use complex `ADMIN_CODE`

### 3. Docker Security
- ✅ Run containers as non-root user
- ✅ Use Docker secrets for sensitive data
- ✅ Keep Docker images updated
- ✅ Monitor container logs

### 4. Network Security
- ✅ Use HTTPS for production
- ✅ Configure firewall rules
- ✅ Limit SSH access to specific IPs
- ✅ Enable fail2ban for SSH protection

---

## Monitoring

### Health Check

```bash
# Application health endpoint
curl http://localhost:8080/healthz

# Container health
sudo docker-compose ps

# Disk usage
df -h

# Docker system info
sudo docker system df
```

### Setting Up Monitoring (Optional)

```bash
# Install monitoring tools
sudo apt install htop iotop nethogs

# Monitor resources
htop
```

---

## Production Checklist

- [ ] Update `APP_BASE_URL` to production domain
- [ ] Change `IP_HASH_SALT` to strong random string
- [ ] Change `ADMIN_CODE` to secure code
- [ ] Set `GIN_MODE=release` for production
- [ ] Configure HTTPS/SSL certificate
- [ ] Setup firewall rules
- [ ] Enable automatic backups
- [ ] Setup log rotation
- [ ] Monitor disk space
- [ ] Test deployment workflow
- [ ] Verify database persistence
- [ ] Test vote functionality
- [ ] Test admin dashboard

---

## Quick Reference

```bash
# SSH to VPS
ssh username@your-vps-ip

# Deploy manually
cd /home/bitnami/vote-3dvista
git pull origin main
sudo docker-compose down
sudo docker-compose up -d --build

# Check status
sudo docker-compose ps

# View logs
sudo docker-compose logs -f

# Stop application
sudo docker-compose down

# Start application
sudo docker-compose up -d

# Restart application
sudo docker-compose restart

# Access database
sudo docker-compose exec db psql -U postgres -d voteweb
```

---

## Support

Jika ada masalah dengan deployment:

1. Check GitHub Actions logs
2. SSH ke VPS dan check container logs
3. Verify all GitHub Secrets are set correctly
4. Test SSH connection manually
5. Check VPS resources (CPU, RAM, disk)

